# Spring AOP

처음 다뤘던 내용과 같이 애플리케이션의 비즈니스 로직은 핵심 기능과 부가 기능으로 분리할 수 있다.
`핵심 기능`은 도메인의 객체가 수행하는 고유의 기능이다. 
`부가 기능`은 핵심 기능을 보조하기위해 제공하는 기능이다. 예를 들어서 로그 추적 로직, 트랜잭션 기능 등이 이에 해당된다.
`핵심 기능`은 각 객체의 고유 기능이기에 중복적인 수행이 아니지만, `부가 기능`은 동일한 기능을 수행하기 때문에 각 도메인마다 중복되는 기능이 수행된다. 
객체지향적인 코드를 짜기 위해서는 중복된 내용은 하나의 추상화를 통해 공통적으로 사용할 수 있는 하나의 객체로 생성할 수 있고 이를 상속 또는 합성을 통해 사용하는 방법을 수행할 수 있다.

이 `부가 기능`을 적용하기 위해 해결해야 하는 문제를 정리하면 다음과 같다.
1. 부가 기능 적용을 위해 많은 수정이 필요하다.
2. 부가 기능 적용을 위해 많은 반복 작업이 필요하다.
3. 부가 기능을 변경하게 되면 많은 수정 및 중복 작업이 필요하다.
4. 부가 기능을 적용하는 대상을 변경하면 많은 수정이 필요하다.

이 문제를 하나의 추상체로 만든것이 Aspect이다. Aspect에서는 부가 기과 부가 기능을 어디에 적용할 것인지 정의할 수 있다.
그리고 스프링에서는 AOP(Aspect Oriented Programming)라는 이름으로 이를 제공한다.

## AOP 적용 방식 - 컴파일 타임 위빙 

Java 파일을 컴파일 하는 과정에서 `위빙`이라는 개념을 적용하여  클래스 파일을 만드는 시점에 부가 기능 로직을 추가하게 된다.
부가 기능 로직을 추가하는 단계에서 AspectJ 컴파일러는 Aspect를 확인해서 해당 클래스가 적용할 대상인지 확인  부가 기능 로직을 적용시킨다.
이 과정에서는 특별한 컴파일러가 복잡한 과정을 거쳐야 한다는 단점이 있다.

## AOP 적용 방식 - 로드타임 위빙

자바를 실행하면 .class파일을 JVM 내부의 Class Loader에 저장하게된다. 이때 클래스 로더에 적재하기 이전에 파일을 조작할 수 있다.
이 시점에 부가 기능을 적용 하는 것을 `로드 타임 위빙`이라고 한다.
이때  클래스 로더 조기를 지정해주는 과정이 필요한데 이 방법또한 복잡하다.

## AOP 적용 방식 - 런타임 위빙

런타임 위빙은 클래스를 컴파일하거나 로딩 하는 과정 이후에 적용하는 방식이다.
이때 스프링에서 빈 객체를 생성하고 스프링 컨테이너 내부에 빈의 의존성을 연결하기 이전 과정에서 실제 객체를 프록시 객체로 바꿔치기하여 AspectJ 모듈을 적용시킬 수 있다.

## AOP 적용 시점

AOP는 메서 실행 시점에서 사용할 수 있다.
프록시는 메서드를 오버 라이딩하여 사용하기 때문에 생성자나 static 메서드, 필드 값에는 프록시를 적용하여 사용할 수 없다.
런타임에 빈 객체를 사용하여 프록시 객체를 사용하기 때문에 빈으로 등록되지 않은 객체는 사용이 불가능하다.

## AOP 용어

- **Join Point**
  - AOP를 적용할 수 있는 메서드 포인트를 말한다
- **Point Cut**
  - 조인 포인 중에서 어드바이스가 적용될 위치를 설정할 수 있다
  - AspectJ 표현식을 사용한다
- **Target**
  - 어드바이스를 받는 객체, 포인트 컷으로 결정한다
- **Advice**
  - 특정 Join Point에서 수행할 기능에 대해 정의한다
  - Around, Before, After등의 어노테이션을 사용하여 프록시 객체의 수행 지점을 설정할 수 있다.
- **Aspect**
  - Advice + PointCut의 기능
  - Aspect 어노테이션을 적용한다.
  - 여러 Advice와 PointCut이 존재한다.
-  **Advisor**
  - 하나의 Advice + PointCut
  - Spring AOP 에서만 적용하는 개념이다.
- **Weaving**
  - PointCut으로 결정한 타겟의 Join Point에  Advice를 적용하는 것
  - 위빙을 통해 기존 코드를 수정하지 않고 부가 기능을 추가할 수 있다.

### 예제1

@Around 어노테이션을 사용하여 포인트컷을 설정한다.
logProcess는 @Aspect를 적용하여 어드바이스가 된다.
execution(* com.example.loggingtest.domain.user..*(..)) 이 구문은 AspectJ의 표현식이다.
해당 표현식 내의 모든 메서드는 프록시 객체로 생성되어 AOP적용 대상이 된다.

```java

@Slf4j
@Aspect
@Component
public class AspectV1 {
    @Around("execution(* com.example.loggingtest.domain.user..*(..))")
    public Object logProcess(ProceedingJoinPoint joinPoint) throws Throwable {
        log.info("[log] {}", joinPoint.getSignature().getName());
        return joinPoint.proceed();
    }
}

```

### 예제2



